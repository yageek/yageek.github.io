<!doctype html><html lang=en><head><title>Geotagging JPEG with Core Foundation - yageek</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content="The personal website of Yannick Heinrich Geotagging JPEG with Core Foundation " name=description><meta content="cocoa, apple, development, help, foundation" name=keywords><meta content="Yannick Heinrich - Geotagging JPEG with Core Foundation" property=og:title><meta content=website property=og:type><meta content=https://blog.yageek.net/geotagging-jpeg-with-core-foundation/ property=og:url><meta content="The personal website of Yannick Heinrich" property=og:description><link as=font crossorigin href=https://blog.yageek.net/assets/fonts/FiraCode-Regular.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://blog.yageek.net/assets/fonts/FiraCode-Bold.woff2 rel=preload type=font/woff2><link href="https://blog.yageek.net/style.css?h=97e262212a0704163528" rel=stylesheet><link href="https://blog.yageek.net/color/green.css?h=c685075d8d57bb1e0d87" rel=stylesheet><link href=https://blog.yageek.net/atom.xml rel=alternate title=RSS type=application/atom+xml><body><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/> <div class=logo>yageek</div> </a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href="
    
        https://blog.yageek.net/about
    
">about</a><li><a href="
    
        https://blog.yageek.net/projects
    
">projects</a><li><a href="
    
        https://speakerdeck.com/yageek
    
">speakerdeck</a><li><a href="
    
        https://github.com/yageek
    
">github</a><li><a href="
    
        https://www.linkedin.com/in/yageek/
    
">linkedin</a><li><a href="
    
        https://www.strava.com/athletes/30110076
    
">strava</a></ul><ul class="menu__inner menu__inner--mobile"><li><a href="
    
        https://blog.yageek.net/about
    
">about</a><li><a href="
    
        https://blog.yageek.net/projects
    
">projects</a><li><a href="
    
        https://speakerdeck.com/yageek
    
">speakerdeck</a><li><a href="
    
        https://github.com/yageek
    
">github</a><li><a href="
    
        https://www.linkedin.com/in/yageek/
    
">linkedin</a><li><a href="
    
        https://www.strava.com/athletes/30110076
    
">strava</a></ul></nav></header><div class=content><article class=post><header><h1 class=post-title><a href=https://blog.yageek.net/geotagging-jpeg-with-core-foundation/>Geotagging JPEG with Core Foundation</a></h1><div class=post-meta><span class=post-date>2013.01.12 </span><span class=post-author></span> :: {<a href=https://blog.yageek.net/categories/cocoa/>cocoa</a>, <a href=https://blog.yageek.net/categories/apple/>apple</a>} :: #<a href=https://blog.yageek.net/tags/development/>development</a> #<a href=https://blog.yageek.net/tags/help/>help</a> #<a href=https://blog.yageek.net/tags/foundation/>foundation</a></div></header><p>I was searching a way to edit or add GPS metadata of JPEG files without using an external library inside a Mac Application. After looking on internet and reading the ImageIOKit documentation, I found an interesting <a href=https://blog.yageek.net/geotagging-jpeg-with-core-foundation/%22http://lists.apple.com/archives/aperture-dev/2008/Jul/msg00000.html>post on the Apple Mailing List</a> talking about this topic and an old bug related to it. It includes a code sample that is apparently working now (Mac Os X 10.8).<p>I just wanted to add some details about it:<ul><li><p>The values corresponding to the <code>kCGImagePropertyGPSLatitudeRef</code>/<code>kCGImagePropertyGPSLongitudedRef</code> keys are expected to be of type <code>NSString</code>.</p><li><p>The values corresponding to the <code>kCGImagePropertyGPSLatitude/kCGImagePropertyGPSLongitude</code> keys are expected to be of type <code>NSNumber</code>.</p></ul><pre class=giallo style=color:#cdd6f4;background-color:#1e1e2e><code data-lang=objective-c><span class=giallo-l><span> CGImageSourceRef originalImageSource </span><span style=color:#94e2d5>=</span><span style=color:#89b4fa;font-style:italic> CGImageSourceCreateWithURL</span><span style=color:#9399b2>((</span><span>CFURLRef</span><span style=color:#9399b2>)</span><span style=color:#eba0ac;font-style:italic>imageURL</span><span style=color:#9399b2>,</span><span style=color:#f38ba8> NULL</span><span style=color:#9399b2>);</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  //get gps metadata  </span></span>
<span class=giallo-l><span style=color:#f9e2af;font-style:italic>  NSDictionary</span><span style=color:#94e2d5> *</span><span>metadata </span><span style=color:#94e2d5>=</span><span style=color:#9399b2> (</span><span style=color:#f9e2af;font-style:italic>NSDictionary</span><span style=color:#94e2d5> *</span><span style=color:#9399b2>)</span><span>CGImageSourceCopyPropertiesAtIndex(originalImageSource,0,NULL);  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  //make the metadata dictionary mutable so we can add properties to it  </span></span>
<span class=giallo-l><span style=color:#f9e2af;font-style:italic>  NSMutableDictionary</span><span style=color:#94e2d5> *</span><span>metadataAsMutable </span><span style=color:#94e2d5>=</span><span style=color:#9399b2> [[</span><span>metadata </span><span style=color:#89b4fa;font-style:italic>mutableCopy</span><span style=color:#9399b2>]</span><span>autorelease</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2>  [</span><span>metadata </span><span style=color:#89b4fa;font-style:italic>release</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  //get mutable gps data  </span></span>
<span class=giallo-l><span style=color:#f9e2af;font-style:italic>  NSMutableDictionary</span><span style=color:#94e2d5> *</span><span>GPSDictionary </span><span style=color:#94e2d5>=</span><span style=color:#9399b2> [[[</span><span>metadataAsMutable </span><span style=color:#89b4fa;font-style:italic>objectForKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5> *</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSDictionary</span><span style=color:#9399b2>]</span><span>mutableCopy</span><span style=color:#9399b2>]</span><span>autorelease</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span style=color:#cba6f7>  if</span><span style=color:#9399b2>(</span><span style=color:#94e2d5>!</span><span>GPSDictionary</span><span style=color:#9399b2>)</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2>  {</span><span>  </span></span>
<span class=giallo-l><span>     GPSDictionary </span><span style=color:#94e2d5>=</span><span style=color:#9399b2> [</span><span style=color:#f9e2af;font-style:italic>NSMutableDictionary</span><span style=color:#89b4fa;font-style:italic> dictionary</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2>   }</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  //Upate latitude longitude</span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  // latRef and lonRef are NSString</span></span>
<span class=giallo-l><span style=color:#9399b2>    [</span><span>GPSDictionary </span><span style=color:#89b4fa;font-style:italic>setObject</span><span style=color:#9399b2>:[</span><span style=color:#f9e2af;font-style:italic>NSNumber</span><span style=color:#89b4fa;font-style:italic> numberWithFloat</span><span style=color:#9399b2>:</span><span>lat</span><span style=color:#9399b2>]</span><span style=color:#89b4fa;font-style:italic> forKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5>*</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSLatitude</span><span style=color:#9399b2>];</span></span>
<span class=giallo-l><span style=color:#9399b2>    [</span><span>GPSDictionary </span><span style=color:#89b4fa;font-style:italic>setObject</span><span style=color:#9399b2>:</span><span>latRef </span><span style=color:#89b4fa;font-style:italic>forKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5>*</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSLatitudeRef</span><span style=color:#9399b2>];</span></span>
<span class=giallo-l><span>      </span></span>
<span class=giallo-l><span style=color:#9399b2>    [</span><span>GPSDictionary </span><span style=color:#89b4fa;font-style:italic>setObject</span><span style=color:#9399b2>:[</span><span style=color:#f9e2af;font-style:italic>NSNumber</span><span style=color:#89b4fa;font-style:italic> numberWithFloat</span><span style=color:#9399b2>:</span><span>lon</span><span style=color:#9399b2>]</span><span style=color:#89b4fa;font-style:italic> forKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5>*</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSLongitude</span><span style=color:#9399b2>];</span></span>
<span class=giallo-l><span style=color:#9399b2>    [</span><span>GPSDictionary </span><span style=color:#89b4fa;font-style:italic>setObject</span><span style=color:#9399b2>:</span><span>lonRef </span><span style=color:#89b4fa;font-style:italic>forKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5>*</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSLongitudeRef</span><span style=color:#9399b2>];</span></span>
<span class=giallo-l><span> </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>  //add our modified GPS data back into the image's metadata  </span></span>
<span class=giallo-l><span style=color:#9399b2>  [</span><span>metadataAsMutable </span><span style=color:#89b4fa;font-style:italic>setObject</span><span style=color:#9399b2>:</span><span>GPSDictionary </span><span style=color:#89b4fa;font-style:italic>forKey</span><span style=color:#9399b2>:(</span><span style=color:#f9e2af;font-style:italic>NSString</span><span style=color:#94e2d5> *</span><span style=color:#9399b2>)</span><span>kCGImagePropertyGPSDictionary</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span style=color:#89b4fa;font-style:italic>  NSLog</span><span style=color:#9399b2>(</span><span style=color:#a6e3a1>@"Updated metadata: %@"</span><span style=color:#9399b2>,</span><span> metadataAsMutable</span><span style=color:#9399b2>);</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>   // Create a new image source that reads the TIFF data that we get from our NSImage.  </span></span>
<span class=giallo-l><span style=color:#f9e2af;font-style:italic>   NSData</span><span style=color:#94e2d5> *</span><span>imageData </span><span style=color:#94e2d5>=</span><span style=color:#9399b2> [</span><span>newImage </span><span style=color:#89b4fa;font-style:italic>TIFFRepresentation</span><span style=color:#9399b2>];</span><span>  </span></span>
<span class=giallo-l><span>   CGImageSourceRef finalImageSource </span><span style=color:#94e2d5>=</span><span style=color:#89b4fa;font-style:italic> CGImageSourceCreateWithData</span><span style=color:#9399b2>((</span><span>CFDataRef</span><span style=color:#9399b2>)</span><span style=color:#eba0ac;font-style:italic>imageData</span><span style=color:#9399b2>,</span><span style=color:#f38ba8> NULL</span><span style=color:#9399b2>);</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>   // Create an image destination. This will take the image data from our source, and write it along with the metadata we read above  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>   // into a file in the correct format.  </span></span>
<span class=giallo-l><span>   CGImageDestinationRef imageDestination </span><span style=color:#94e2d5>=</span><span style=color:#89b4fa;font-style:italic> CGImageDestinationCreateWithURL</span><span style=color:#9399b2>((</span><span>CFURLRef</span><span style=color:#9399b2>)</span><span style=color:#eba0ac;font-style:italic>imageURL</span><span style=color:#9399b2>,</span><span> imageType</span><span style=color:#9399b2>,</span><span style=color:#fab387> 1</span><span style=color:#9399b2>,</span><span style=color:#f38ba8> NULL</span><span style=color:#9399b2>);</span><span>  </span></span>
<span class=giallo-l><span style=color:#89b4fa;font-style:italic>   CGImageDestinationAddImageFromSource</span><span style=color:#9399b2>(</span><span>imageDestination</span><span style=color:#9399b2>,</span><span> finalImageSource</span><span style=color:#9399b2>,</span><span style=color:#fab387> 0</span><span style=color:#9399b2>, (</span><span>CFDictionaryRef</span><span style=color:#9399b2>)</span><span style=color:#eba0ac;font-style:italic>metadataAsMutable</span><span style=color:#9399b2>);</span><span>  </span></span>
<span class=giallo-l><span style=color:#cba6f7>   if</span><span style=color:#9399b2> (</span><span style=color:#94e2d5>!</span><span style=color:#89b4fa;font-style:italic>CGImageDestinationFinalize</span><span style=color:#9399b2>(</span><span>imageDestination</span><span style=color:#9399b2>))</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2>   {</span><span>  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>         // The sample code doesn't do any specific error handling in this case. This would be an appropriate  </span></span>
<span class=giallo-l><span style=color:#9399b2;font-style:italic>         // place to notify the user, put up an alert, etc.  </span></span>
<span class=giallo-l><span style=color:#9399b2>   }</span><span>  </span></span></code></pre></article></div><div class=pagination><div class=pagination__buttons></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2026 <a href=https://github.com/ejmg/zerm>zerm</a> :: Powered by <a href=https://www.getzola.org/>Zola</a></span><span>:: Theme made by <a href=https://github.com/ejmg>ejmg</a></span></div><script src=https://blog.yageek.net/assets/js/main.js></script></div></footer></div>
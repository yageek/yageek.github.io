<!doctype html><html lang=en><head><title>Geotagging JPEG with Core Foundation - yageek</title><meta content="text/html; charset=utf-8"http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1"name=viewport><meta content="The personal website of Yannick Heinrich Geotagging JPEG with Core Foundation "name=description><meta content="cocoa, apple, development, help, foundation"name=keywords><meta content="Yannick Heinrich - Geotagging JPEG with Core Foundation"property=og:title><meta content=website property=og:type><meta content=https://yageek.net/geotagging-jpeg-with-core-foundation/ property=og:url><meta content="The personal website of Yannick Heinrich"property=og:description><link as=font crossorigin=anonymous href=https://yageek.net/assets/fonts/FiraCode-Regular.woff2 rel=preload type=font/woff2><link as=font crossorigin=anonymous href=https://yageek.net/assets/fonts/FiraCode-Bold.woff2 rel=preload type=font/woff2><link href="https://yageek.net/style.css?h=2c8d17b7aa9535c98dc3b725d1bc9c6b2e12b81df07df95e5d9af6dcb88e7c78"rel=stylesheet><link href="https://yageek.net/color/green.css?h=5a347e8c6d0c143f1dc7bfd18df37abdfa7c3c45951262b9f8b4bcc829a2ab94"rel=stylesheet><body><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/> <div class=logo>yageek</div> </a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href="
    
        https://yageek.net/about
    
">about</a><li><a href="
    
        https://yageek.net/projects
    
">projects</a><li><a href="
    
        https://speakerdeck.com/yageek
    
">talks</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>show more ▾</li><ul class="menu__sub-inner-more hidden"><li><a href="
    
        https://github.com/yageek
    
">github</a><li><a href="
    
        https://www.linkedin.com/in/yageek/
    
">linkedin</a><li><a href="
    
        https://twitter.com/yageek
    
">twitter</a></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href="
    
        https://yageek.net/about
    
">about</a><li><a href="
    
        https://yageek.net/projects
    
">projects</a><li><a href="
    
        https://speakerdeck.com/yageek
    
">talks</a><li><a href="
    
        https://github.com/yageek
    
">github</a><li><a href="
    
        https://www.linkedin.com/in/yageek/
    
">linkedin</a><li><a href="
    
        https://twitter.com/yageek
    
">twitter</a></ul></nav></header><div class=content><article class=post><header><h1 class=post-title><a href=https://yageek.net/geotagging-jpeg-with-core-foundation/>Geotagging JPEG with Core Foundation</a></h1><div class=post-meta><span class=post-date>2013.01.12 </span><span class=post-author></span> :: {<a href=https://yageek.net/categories/cocoa/>cocoa</a>, <a href=https://yageek.net/categories/apple/>apple</a>} :: #<a href=https://yageek.net/tags/development/>development</a> #<a href=https://yageek.net/tags/help/>help</a> #<a href=https://yageek.net/tags/foundation/>foundation</a></div></header><p>I was searching a way to edit or add GPS metadata of JPEG files without using an external library inside a Mac Application. After looking on internet and reading the ImageIOKit documentation, I found an interesting <a href=%22http://lists.apple.com/archives/aperture-dev/2008/Jul/msg00000.html>post on the Apple Mailing List</a> talking about this topic and an old bug related to it. It includes a code sample that is apparently working now (Mac Os X 10.8).<p>I just wanted to add some details about it:<ul><li><p>The values corresponding to the <code>kCGImagePropertyGPSLatitudeRef</code>/<code>kCGImagePropertyGPSLongitudedRef</code> keys are expected to be of type <code>NSString</code>.</p><li><p>The values corresponding to the <code>kCGImagePropertyGPSLatitude/kCGImagePropertyGPSLongitude</code> keys are expected to be of type <code>NSNumber</code>.</p></ul><pre class=language-objective-c data-lang=objective-c style=background-color:#2b303b;color:#c0c5ce;><code class=language-objective-c data-lang=objective-c><span> CGImageSourceRef originalImageSource = </span><span style=color:#bf616a;>CGImageSourceCreateWithURL</span><span>((CFURLRef)imageURL, </span><span style=color:#d08770;>NULL</span><span>);  
</span><span>  </span><span style=color:#65737e;>//get gps metadata  
</span><span>  </span><span style=color:#ebcb8b;>NSDictionary </span><span>*metadata = (</span><span style=color:#ebcb8b;>NSDictionary </span><span>*)</span><span style=color:#bf616a;>CGImageSourceCopyPropertiesAtIndex</span><span>(originalImageSource,</span><span style=color:#d08770;>0</span><span>,</span><span style=color:#d08770;>NULL</span><span>);  
</span><span>  </span><span style=color:#65737e;>//make the metadata dictionary mutable so we can add properties to it  
</span><span>  </span><span style=color:#ebcb8b;>NSMutableDictionary </span><span>*metadataAsMutable = [[metadata </span><span style=color:#8fa1b3;>mutableCopy</span><span>]autorelease];  
</span><span>  [metadata </span><span style=color:#8fa1b3;>release</span><span>];  
</span><span>  </span><span style=color:#65737e;>//get mutable gps data  
</span><span>  </span><span style=color:#ebcb8b;>NSMutableDictionary </span><span>*GPSDictionary = [[[metadataAsMutable </span><span style=color:#8fa1b3;>objectForKey:</span><span>(</span><span style=color:#ebcb8b;>NSString </span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSDictionary</span><span>]mutableCopy]autorelease];  
</span><span>  </span><span style=color:#b48ead;>if</span><span>(!GPSDictionary)  
</span><span>  {  
</span><span>     GPSDictionary = [</span><span style=color:#ebcb8b;>NSMutableDictionary </span><span style=color:#8fa1b3;>dictionary</span><span>];  
</span><span>   }  
</span><span>  </span><span style=color:#65737e;>//Upate latitude longitude
</span><span>  </span><span style=color:#65737e;>// latRef and lonRef are NSString
</span><span>    [GPSDictionary </span><span style=color:#8fa1b3;>setObject:</span><span>[</span><span style=color:#ebcb8b;>NSNumber </span><span style=color:#8fa1b3;>numberWithFloat:</span><span>lat] </span><span style=color:#8fa1b3;>forKey:</span><span>(</span><span style=color:#ebcb8b;>NSString</span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSLatitude</span><span>];
</span><span>    [GPSDictionary </span><span style=color:#8fa1b3;>setObject:</span><span>latRef </span><span style=color:#8fa1b3;>forKey:</span><span>(</span><span style=color:#ebcb8b;>NSString</span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSLatitudeRef</span><span>];
</span><span>      
</span><span>    [GPSDictionary </span><span style=color:#8fa1b3;>setObject:</span><span>[</span><span style=color:#ebcb8b;>NSNumber </span><span style=color:#8fa1b3;>numberWithFloat:</span><span>lon] </span><span style=color:#8fa1b3;>forKey:</span><span>(</span><span style=color:#ebcb8b;>NSString</span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSLongitude</span><span>];
</span><span>    [GPSDictionary </span><span style=color:#8fa1b3;>setObject:</span><span>lonRef </span><span style=color:#8fa1b3;>forKey:</span><span>(</span><span style=color:#ebcb8b;>NSString</span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSLongitudeRef</span><span>];
</span><span> 
</span><span>  </span><span style=color:#65737e;>//add our modified GPS data back into the image's metadata  
</span><span>  [metadataAsMutable </span><span style=color:#8fa1b3;>setObject:</span><span>GPSDictionary </span><span style=color:#8fa1b3;>forKey:</span><span>(</span><span style=color:#ebcb8b;>NSString </span><span>*)</span><span style=color:#d08770;>kCGImagePropertyGPSDictionary</span><span>];  
</span><span>  </span><span style=color:#bf616a;>NSLog</span><span>(@"</span><span style=color:#a3be8c;>Updated metadata: </span><span style=color:#d08770;>%@</span><span>", metadataAsMutable);  
</span><span>   </span><span style=color:#65737e;>// Create a new image source that reads the TIFF data that we get from our NSImage.  
</span><span>   </span><span style=color:#ebcb8b;>NSData </span><span>*imageData = [newImage </span><span style=color:#8fa1b3;>TIFFRepresentation</span><span>];  
</span><span>   CGImageSourceRef finalImageSource = </span><span style=color:#bf616a;>CGImageSourceCreateWithData</span><span>((CFDataRef)imageData, </span><span style=color:#d08770;>NULL</span><span>);  
</span><span>   </span><span style=color:#65737e;>// Create an image destination. This will take the image data from our source, and write it along with the metadata we read above  
</span><span>   </span><span style=color:#65737e;>// into a file in the correct format.  
</span><span>   CGImageDestinationRef imageDestination = </span><span style=color:#bf616a;>CGImageDestinationCreateWithURL</span><span>((CFURLRef)imageURL, imageType, </span><span style=color:#d08770;>1</span><span>, </span><span style=color:#d08770;>NULL</span><span>);  
</span><span>   </span><span style=color:#bf616a;>CGImageDestinationAddImageFromSource</span><span>(imageDestination, finalImageSource, </span><span style=color:#d08770;>0</span><span>, (CFDictionaryRef)metadataAsMutable);  
</span><span>   </span><span style=color:#b48ead;>if </span><span>(!</span><span style=color:#bf616a;>CGImageDestinationFinalize</span><span>(imageDestination))  
</span><span>   {  
</span><span>         </span><span style=color:#65737e;>// The sample code doesn't do any specific error handling in this case. This would be an appropriate  
</span><span>         </span><span style=color:#65737e;>// place to notify the user, put up an alert, etc.  
</span><span>   }  
</span></code></pre></article></div><div class=pagination><div class=pagination__buttons></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 <a href=https://github.com/ejmg/zerm>zerm</a> :: Powered by <a href=https://www.getzola.org/>Zola</a></span><span>:: Theme made by <a href=https://github.com/ejmg>ejmg</a></span></div><script src=https://yageek.net/assets/js/main.js></script></div></footer></div>